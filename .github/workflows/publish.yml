name: Publish to VSCode Marketplace

on:
  # Trigger after CI completes successfully on main/master
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - master
      - main

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  publish:
    # Only run if CI was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ inputs.version }}"
        else
          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")
        fi
        # Remove 'v' prefix if present
        VERSION=${VERSION#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Publishing version: $VERSION"

    - name: Update package.json version (if manual dispatch)
      if: github.event_name == 'workflow_dispatch'
      run: |
        npm version ${{ steps.get_version.outputs.version }} --no-git-tag-version

    - name: Package extension
      run: npx vsce package

    - name: Publish to VSCode Marketplace
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
      run: npx vsce publish -p $VSCE_PAT

    - name: Upload VSIX as workflow artifact
      uses: actions/upload-artifact@v4
      with:
        name: vibetty-${{ steps.get_version.outputs.version }}.vsix
        path: '*.vsix'

    - name: Create Git tag
      if: github.event_name == 'workflow_run'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "v${{ steps.get_version.outputs.version }}" -m "Release v${{ steps.get_version.outputs.version }}"
        git push origin "v${{ steps.get_version.outputs.version }}"
